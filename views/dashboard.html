<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pilgram Admin Dashboard</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .tab-btn.active {
      border: 2px solid #10b981;
      background: #222;
    }
    @media (min-width: 768px) {
      canvas {
        max-height: 250px !important;
      }
    }

    .pagination {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 1rem;
    }

    .pagination button {
      padding: 6px 12px;
      background: #222;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
      cursor: pointer;
    }

    .pagination button.active {
      background: #22c55e;
      color: black;
      font-weight: bold;
    }

    .table-wrapper {
      overflow-x: auto;
      max-width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.75rem;
      border: 1px solid #333;
      text-align: left;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <header>
    <img src="/logo1.png" alt="Logo" style="height:40px;margin-bottom:1rem;">
    <a href="/logout" class="logout-btn">Logout</a>
  </header>

  <main>
    <section class="tab-buttons">
      <button class="tab-btn active" onclick="showTab('sales', this)">üí∞ Sales</button>
      <button class="tab-btn" onclick="showTab('behavior', this)">üë• User Behavior</button>
      <button class="tab-btn" onclick="showTab('traffic', this)">üåê Traffic</button>
    </section>

    <div id="tab-sales" class="tab-content">
      <h2>Sales</h2>
      <canvas id="salesChart"></canvas>
      <canvas id="revenueChart"></canvas>
      <div class="card">
        <h2>Sorted Orders</h2>
        <a href="/export/orders" class="export-btn">Export Orders</a>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Product</th>
                <th>ID</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="orders"></tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <div id="tab-behavior" class="tab-content" style="display:none;">
      <h2>User Behavior</h2>
      <ul>
        <li>Scroll Depth: <span id="scrollDepth">-</span></li>
        <li>Clicks: <span id="clicks">-</span></li>
        <li>Time on Page: <span id="timeOnPage">-</span></li>
      </ul>
    </div>

    <div id="tab-traffic" class="tab-content" style="display:none;">
      <h2>Traffic</h2>
      <canvas id="homepageChart"></canvas>
      <ul>
        <li>Top Countries: <span id="geoData"></span></li>
        <li>Devices: <span id="deviceData"></span></li>
        <li>Referrals: <span id="referralData"></span></li>
      </ul>
    </div>
  </main>
  
  	   <script>
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const homepageCtx = document.getElementById('homepageChart').getContext('2d');

    const dummyOrders = [
      { email: 'user1@example.com', product: 'Shein Box', id: 'A001', time: '2025-04-18 08:00' },
      { email: 'user2@example.com', product: 'iPhone Quiz', id: 'A002', time: '2025-04-18 09:00' },
      { email: 'user3@example.com', product: 'Temu Box', id: 'A003', time: '2025-04-18 10:30' },
      { email: 'user4@example.com', product: 'Shein Box', id: 'A004', time: '2025-04-18 11:00' },
      { email: 'user5@example.com', product: 'iPhone Quiz', id: 'A005', time: '2025-04-18 12:15' },
      { email: 'user6@example.com', product: 'Temu Box', id: 'A006', time: '2025-04-18 13:45' },
      { email: 'user7@example.com', product: 'Temu Box', id: 'A007', time: '2025-04-18 14:30' },
      { email: 'user8@example.com', product: 'Shein Box', id: 'A008', time: '2025-04-18 15:00' },
    ];

    const rowsPerPage = 5;
    let currentPage = 1;

    function paginateOrders() {
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const visibleOrders = dummyOrders.slice(start, end);

      const tbody = document.getElementById('orders');
      tbody.innerHTML = '';
      visibleOrders.forEach(order => {
        const row = `<tr><td>${order.email}</td><td>${order.product}</td><td>${order.id}</td><td>${order.time}</td></tr>`;
        tbody.innerHTML += row;
      });

      const totalPages = Math.ceil(dummyOrders.length / rowsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }
    }

    function goToPage(page) {
      currentPage = page;
      paginateOrders();
    }

    paginateOrders();

    const salesChart = new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
          label: 'Sales by Day',
          data: [5, 8, 4, 10, 6, 9, 3],
          backgroundColor: 'rgba(34,197,94,0.7)',
        }]
      },
      options: {
        plugins: { legend: { labels: { color: 'white' } } },
        scales: {
          x: { ticks: { color: 'white' } },
          y: { ticks: { color: 'white' } }
        }
      }
    });

    const revenueChart = new Chart(revenueCtx, {
      type: 'bar',
      data: {
        labels: ['Shein Box', 'iPhone Quiz', 'Temu Box'],
        datasets: [{
          label: 'Revenue by Product',
          data: [150, 300, 90],
          backgroundColor: ['#10b981', '#3b82f6', '#f59e0b']
        }]
      },
      options: {
        plugins: { legend: { labels: { color: 'white' } } },
        scales: {
          x: { ticks: { color: 'white' } },
          y: { ticks: { color: 'white' } }
        }
      }
    });

    const homepageChart = new Chart(homepageCtx, {
      type: 'line',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
          label: 'Homepage Views',
          data: [120, 140, 115, 180, 130, 160, 190],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.3)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        plugins: { legend: { labels: { color: 'white' } } },
        scales: {
          x: { ticks: { color: 'white' } },
          y: { ticks: { color: 'white' } }
        }
      }
    });

    function showTab(tabName, btn) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabName).style.display = 'block';
      btn.classList.add('active');
    }

    // Behavior dummy
    document.getElementById('scrollDepth').textContent = "67%";
    document.getElementById('clicks').textContent = "4.2";
    document.getElementById('timeOnPage').textContent = "62";

  </script>
  
  <!-- STEP 3: API Hookup to Shoppy Orders -->
<script>
  async function fetchOrdersFromShoppy() {
    try {
      const res = await fetch('/api/shoppy/orders'); // Ensure this route is served by your Express backend
      const data = await res.json();

      // If data is empty or error, fallback to dummy data
      if (!Array.isArray(data) || data.length === 0) {
        console.warn('Using dummy data (no Shoppy orders found)');
        return dummyOrders;
      }

      return data.map(order => ({
        email: order.email,
        product: order.product_name || order.product || 'Unknown',
        id: order.product_id || order.id || '‚Äî',
        time: new Date(order.timestamp || order.created_at).toLocaleString()
      }));
    } catch (err) {
      console.error('Error fetching Shoppy orders:', err);
      return dummyOrders; // fallback to dummy
    }
  }

  async function initializeOrdersWithAPI() {
    const orders = await fetchOrdersFromShoppy();
    dummyOrders.length = 0;
    dummyOrders.push(...orders);
    paginateOrders();
  }

  initializeOrdersWithAPI();
</script>

<!--  Orders Table with Price, Responsive + Export + Pagination -->
<div class="card">
  <h2 class="text-white mb-2">Sorted Orders</h2>
  <a href="/export/orders/csv" class="export-btn">Export Orders as CSV</a>
  <div class="sorted-orders-container">
    <table class="sorted-orders-table">
      <thead>
        <tr>
          <th onclick="sortOrders('email')">Email</th>
          <th onclick="sortOrders('product_name')">Product</th>
          <th onclick="sortOrders('price')">Price</th>
          <th onclick="sortOrders('product_id')">ID</th>
          <th onclick="sortOrders('timestamp')">Time</th>
        </tr>
      </thead>
      <tbody id="orders"></tbody>
    </table>
    <div id="pagination" class="pagination"></div>
  </div>
</div>

<style>
  .sorted-orders-container {
    background-color: #111;
    padding: 1rem;
    border-radius: 1rem;
    box-shadow: 0 0 10px rgba(0,255,0,0.2);
    max-width: 100%;
    overflow-x: auto;
    margin-top: 2rem;
  }

  .sorted-orders-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .sorted-orders-table th, .sorted-orders-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #333;
    white-space: nowrap;
  }

  .sorted-orders-table thead {
    background-color: #1f1f1f;
    color: #ccc;
  }

  #pagination {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  #pagination .tab-btn {
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-size: 0.9rem;
    background: #222;
    color: #00ff99;
    border: 1px solid #00ff99;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }

  #pagination .tab-btn:hover,
  #pagination .tab-btn.active {
    background: #00ff99;
    color: #000;
    font-weight: bold;
  }

  th {
    cursor: pointer;
  }

  th:hover {
    text-decoration: underline;
    color: #00ff99;
  }

  @media screen and (max-width: 768px) {
    .sorted-orders-table th, .sorted-orders-table td {
      font-size: 0.8rem;
      padding: 0.5rem;
    }
    .sorted-orders-container {
      padding: 0.5rem;
    }
  }
</style>

<script>
  let currentPage = 1;
  const rowsPerPage = 5;
  let currentSortKey = null;
  let sortDirection = 1;

  async function fetchAndDisplayOrders() {
    try {
      const response = await fetch('/api/shoppy/orders');
      const orders = await response.json();
      if (!Array.isArray(orders)) throw new Error('Invalid format');
      window.allOrders = orders;
    } catch (err) {
      console.warn("Using dummy orders due to fetch error:", err);
      window.allOrders = dummyOrders;
    }
    renderOrders();
  }

  const dummyOrders = [
    { email: "john@example.com", product_name: "iPhone Quiz", price: 10, product_id: "001", timestamp: "2025-04-18 10:00" },
    { email: "jane@example.com", product_name: "Shein Box", price: 20, product_id: "002", timestamp: "2025-04-18 11:00" },
    { email: "mike@example.com", product_name: "Temu Box", price: 15, product_id: "003", timestamp: "2025-04-18 12:00" },
    { email: "sara@example.com", product_name: "iPhone Quiz", price: 10, product_id: "004", timestamp: "2025-04-18 13:00" },
    { email: "alex@example.com", product_name: "Shein Box", price: 20, product_id: "005", timestamp: "2025-04-18 14:00" },
    { email: "lucy@example.com", product_name: "Temu Box", price: 15, product_id: "006", timestamp: "2025-04-18 15:00" },
    { email: "dan@example.com", product_name: "iPhone Quiz", price: 10, product_id: "007", timestamp: "2025-04-18 16:00" },
    { email: "lisa@example.com", product_name: "Shein Box", price: 20, product_id: "008", timestamp: "2025-04-18 17:00" }
  ];

  function sortOrders(key) {
    if (currentSortKey === key) {
      sortDirection *= -1;
    } else {
      currentSortKey = key;
      sortDirection = 1;
    }
    allOrders.sort((a, b) => {
      const aVal = (a[key] ?? '').toString().toLowerCase();
      const bVal = (b[key] ?? '').toString().toLowerCase();
      return aVal.localeCompare(bVal) * sortDirection;
    });
    currentPage = 1;
    renderOrders();
  }

  function renderOrders() {
    const tbody = document.getElementById('orders');
    tbody.innerHTML = '';
    const start = (currentPage - 1) * rowsPerPage;
    const pageOrders = allOrders.slice(start, start + rowsPerPage);
    pageOrders.forEach(order => {
      tbody.innerHTML += `
        <tr>
          <td>${order.email}</td>
          <td>${order.product_name}</td>
          <td>$${order.price?.toFixed(2) || '‚Äî'}</td>
          <td>${order.product_id}</td>
          <td>${order.timestamp}</td>
        </tr>`;
    });
    renderPagination();
  }

  function renderPagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(allOrders.length / rowsPerPage);
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'tab-btn' + (i === currentPage ? ' active' : '');
      btn.onclick = () => {
        currentPage = i;
        renderOrders();
      };
      pagination.appendChild(btn);
    }
  }

  fetchAndDisplayOrders();
</script>

</body>
</html>

